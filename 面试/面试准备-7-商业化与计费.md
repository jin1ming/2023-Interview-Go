# SaaS 多租户与商业化计费系统

## 1. 业务模型设计 (Business Model)

采用了经典的 **"客户(Customer) - 租户(Tenant)" 1:N 双层架构**，适配 B2B 商业模式。

*   **Customer (付费主体)**：
    *   对应代理商或集团总部。
    *   拥有统一的资金池（余额 `remain`），负责支付。
    *   接收账单、余额预警和商务通知。
*   **Tenant (使用主体)**：
    *   对应具体的项目现场（如商场、小区）。
    *   **资源隔离**：数据、设备、权限完全独立。
    *   **共享额度**：所有 Tenant 消耗同一 Customer 的余额。

## 2. 计量计费系统 (Metering & Billing)

### 2.1 计费原理
*   **单位**：**路/天 (Channel-Day)**。
*   **逻辑**：基于设备在线日志 (`device_log`) 计算服务时长。
*   **技术难点**：设备网络抖动导致海量碎片化日志。
*   **解决方案**：
    *   使用 SQL **窗口函数** (`row_number() over partition`) 清洗数据。
    *   合并连续时间段，剔除无效抖动，确保计费精准。

### 2.2 结算模式
1.  **月度结算 (Monthly Settle)**：
    *   每月初自动触发，计算上月总消耗并扣费。
    *   **并发控制**：使用 **Redlock 分布式锁**，保证扣费的原子性，防止多实例重复扣费。
2.  **事件触发结算**：
    *   **停用结算**：租户被手动/欠费停用时，立即计算并扣除当月已产生费用。
    *   **启用结算**：记录新的计费起始点。

## 3. 自动化风控与熔断体系 (Risk Control)

构建了三级风控机制，保障平台资金安全与服务质量。

1.  **智能预警 (Prediction)**：
    *   基于客户历史消耗速率 (Burn Rate) 动态测算。
    *   **触发条件**：`余额 < 3天预计消耗量`。
    *   **动作**：发送飞书/邮件预警，预估停机日期，提醒充值。

2.  **欠费熔断 (Circuit Breaker)**：
    *   **触发条件**：`余额 <= 0` 且非后付费客户。
    *   **动作**：
        *   自动触发所有关联 Tenant 的**停用结算**。
        *   强制修改 Tenant 状态为 `Disabled`，停止云端服务。
        *   发送红色高危告警。

3.  **云边隔离保护 (Edge Protection)**：
    *   **策略**：熔断逻辑中豁免边缘场景 (`tenant.scene !== 'dipper'`)。
    *   **价值**：即使云端欠费停服，**边缘端 (Dipper) 设备依然保持本地运行**（人脸识别、门禁通行等核心功能不受影响）。体现了高可用的系统架构设计。

## 4. 数据库设计 (Database Schema)

*   **`customers`**：存储余额、联系人、结算类型。
*   **`tenants`**：存储租户状态、关联关系。
*   **`settlements`**：结算单总表，记录每次扣费金额与类型。
*   **`settlement_details`**：明细表，记录**每个设备**的扣费详情，用于审计对账。

## 5. 管理后台 (Mind System)

Mind 是 Star 项目的后台管理系统，作为商业化计费的可视化操作入口。

*   **核心功能模块**：
    *   **Customers (客户管理)**：管理代理商/集团账户信息、资金池余额查看与充值。
    *   **Tenant (租户管理)**：管理项目现场接入、生命周期维护及资源配置。
    *   **Settle (结算中心)**：
        *   查看月度结算单与流水明细。
        *   处理异常账单与人工调账。
*   **技术架构**：
    *   **前端**：Vue3 + Vite + TypeScript。
    *   **开发模式**：全面采用 Composition API，实现逻辑复用与模块解耦。
