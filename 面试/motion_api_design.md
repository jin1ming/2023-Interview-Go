# Motion API 系统设计与核心亮点 (面试实战版)

> 场景：面试官询问“请介绍一下你负责的 Motion 后端系统的架构设计，以及其中的核心业务难点是如何解决的？”

## 开场白
面试官您好。Motion API 是整个智慧体育解决方案的核心后端服务，它不仅承载了复杂的教务管理逻辑，还起到了连接上层业务与底层 IoT 设施的桥梁作用。

在设计这个系统时，我采用了**分层架构**与**微服务集成**相结合的模式，主要解决了**复杂多租户教务模型**、**海量设备统一管理**以及**端云配置同步**这三大核心问题。

---

### 1. 整体架构设计
系统基于 **Go (Gin框架)** 构建，采用了经典的 Controller-Service-Model 分层结构，以保证代码的可维护性。
*   **存储层**：采用了混合存储策略。
    *   **PostgreSQL**：存储强一致性的业务数据（如租户、学生档案、组织架构）。
    *   **ClickHouse**：用于存储高频的运动数据和时序日志，支撑大屏分析和报表生成。
*   **基础设施集成**：我们没有重复造轮子，而是深度集成了成熟的开源组件。
    *   **Thingsboard**：作为 IoT 底座，负责设备的连接管理、遥测数据收集和 RPC 指令下发。
    *   **Keycloak**：作为统一身份认证中心（IAM），实现了设备端与用户端的统一鉴权。

---

### 2. 核心业务设计亮点

#### 2.1 双层代理的设备管理模型 (Device Facade Pattern)
**挑战**：设备不仅需要在业务层被管理（如绑定班级），还需要在 IoT 平台（连接）和 IAM 平台（鉴权）中注册，状态分散极易导致不一致。
**方案**：
我设计了一个 **DeviceService** 作为统一的编排层（Facade）。
*   **统一注册流**：当业务层创建一个设备时，Service 会自动完成“三步走”：
    1.  在 Thingsboard 中注册设备实体。
    2.  在 Keycloak 中为设备生成独立的 Client 账号（ClientId/Secret）。
    3.  **核心亮点**：将生成的鉴权信息以及业务配置（如 S3 桶、评分标准），回写到 Thingsboard 的 **Shared Attributes** 中。
*   **收益**：实现了**端云配置的自动化同步**。设备开机只需连上 Thingsboard，就能通过订阅属性自动获取最新的鉴权凭证和业务规则，完全解耦了设备固件与业务配置。

#### 2.2 基于 Cron 的自动化教务流转
**挑战**：系统服务于 K12 学校，每年涉及大量班级的升级（如初一升初二）和毕业，人工维护成本极高且容易出错。
**方案**：
设计了一套基于时间维度的**状态机流转机制**。
*   **模型抽象**：将学制（如小学6年）、入学年份、当前时间作为输入。
*   **自动化任务**：通过后台 Cron 任务，每天自动计算所有班级的状态。
    *   自动判断是否该“升级”或“毕业”。
    *   在数据库事务中，批量处理班级状态变更以及学生档案的清洗（如毕业离校）。
*   **收益**：实现了教务管理的“无人值守”，保证了大规模租户数据在学年切换时的准确性和一致性。

---

### 3. 总结
总的来说，Motion API 的设计不仅仅是一个简单的 CRUD 后端。
*   在**业务侧**，它通过精细的数据模型和自动化任务，解决了复杂的教务流转痛点。
*   在**架构侧**，它通过充当 IoT 和 IAM 的上层编排器，屏蔽了底层基础设施的复杂性，为前端和移动端提供了简洁统一的业务接口。
