# 云边协同系统 - 面试介绍话术

## 一、项目开场白（1-2分钟）

### 标准版本

面试官您好，我想介绍一下我参与的项目——**Dipper & Star 云边协同智能视频分析系统**。

这是一套**云边协同的架构**：
- **Star（云端）**：部署在云上的多租户SaaS平台，负责数据汇聚、分析和管理
- **Dipper（边缘）**：部署在边缘端的AI计算平台，负责本地视频分析和实时处理
- **通信方式**：HTTP（同步操作）+ MQTT/ThingsBoard（设备管理和远程控制）

我在项目中主要负责两部分工作：
1. **Star - 租户管理系统**（50%）：设计和实现了完整的多租户SaaS架构，包括租户生命周期管理、数据隔离、配置管理和结算系统
2. **Dipper - 核心服务Merak**（50%）：负责任务调度、IoT平台集成、性能优化等核心功能

项目规模：
- **Star**：支持500+租户，管理10,000+物联网设备，日处理1000万+条抓拍记录
- **Dipper**：部署200+边缘设备，支持100+并发视频流处理

---

## 二、为什么采用云边协同架构？

### 核心原因

| 需求维度 | 边缘端解决 | 云端解决 | 原因 |
|---------|----------|---------|------|
| **数据隐私** | ✅ 本地处理 | - | 视频数据敏感，不能上传云端 |
| **实时性** | ✅ 本地AI推理 | - | 人脸识别需要<100ms延迟 |
| **带宽成本** | ✅ 避免上传 | - | 50个摄像头，每天几TB数据 |
| **多租户管理** | - | ✅ 统一管理 | 需要管理数百个社区/商场 |
| **大数据分析** | - | ✅ 数据汇聚 | 跨社区的统计分析 |
| **远程运维** | - | ✅ IoT平台 | 云端下发任务、远程诊断 |

### 具体场景举例

**智慧社区场景**：
- 社区有50个摄像头，需要实时人脸识别（陌生人告警）
- 同时需要事后检索（查找某人的活动轨迹）
- 数据敏感，不能上传云端
- 运维人员在云端统一管理多个社区

**解决方案**：
- 边缘端（Dipper）：本地处理视频，提取人脸特征，保护隐私
- 云端（Star）：汇聚多个社区的数据，进行跨社区分析，统一结算

---

## 三、系统架构概览

### Star（云端）- 通用基础设施

**技术栈**：
- 前端：Vue 2 + TypeScript + Element UI
- 后端：Node.js (Egg.js) + Golang (Gin) + Java (Flink)
- 数据库：PostgreSQL + ClickHouse + Redis
- 基础设施：Kong网关 + Keycloak认证 + Kafka + K3s

**核心模块**：
1. **Kong API网关**：流量入口、认证、租户隔离、限流熔断
2. **Keycloak**：统一身份认证（支持飞书、微信登录）
3. **PostgreSQL**：主数据库，多租户共享模式，所有表包含tenantId
4. **ClickHouse**：大数据分析库，存储海量抓拍记录
5. **Redis**：缓存和分布式锁
6. **租户管理系统**（我负责）：租户生命周期、数据隔离、配置管理
7. **结算系统**：设备计费、账单生成、欠费预警

### Dipper（边缘）- 微服务系统

**整体架构**：
```
Alkaid (Vue3前端)
    ↓ HTTP/WebSocket
Merak (核心服务 - Go)
    ↓ gRPC
Alioth (视频下载) | Mizar (视频处理) | Dubhe (系统管理)
```

**核心模块**：
1. **Merak**（我的主要工作）：任务调度、IoT集成、数据库管理
2. **Alioth**：从海康NVR下载视频，支持优先级队列
3. **Mizar**：基于FFmpeg的视频处理，C++实现
4. **Dubhe**：网络配置、时间同步、ThingsBoard集成

---

## 四、完整业务流程串联

### 流程1：租户开通与设备部署

```
运营人员 → Star租户管理 → 边缘设备初始化 → ThingsBoard连接
```

**为什么这样设计？**

1. **运营人员在Star创建租户**
   - 创建根区域（组织架构）
   - 创建管理员账号（Keycloak）
   - 在ThingsBoard创建Customer（设备容器）
   - 创建人脸特征库（聚类引擎）
   - 保存租户信息（PostgreSQL）
   - 更新缓存（Redis）
   
   **技术亮点**：分布式事务 + 补偿机制，确保一致性

2. **边缘设备初始化**
   - 使用设备Token认证
   - 建立gRPC连接到ThingsBoard
   - 启动Token自动刷新（提前10分钟）
   - 订阅RPC消息（接收云端命令）
   - 订阅属性更新（同步配置）
   - 上报设备状态（CPU、内存、磁盘）

### 流程2：视频检索任务全流程

```
用户发起检索 → Star接收请求 → IoT下发任务 → Dipper执行 → 结果上报
```

**为什么使用IoT平台而不是直接HTTP调用？**
- 边缘设备可能在内网，无公网IP
- IoT平台提供统一的设备管理和通信通道
- 支持离线消息队列，网络断开时自动重试

**步骤详解**：

1. **用户在Star前端发起检索**
   - 查询人员特征向量（PostgreSQL）
   - 通过IoT平台下发任务到边缘设备
   - 返回taskId，状态为pending

2. **Dipper接收并执行任务**
   - 快速响应（100ms内），避免ThingsBoard超时
   - 异步创建任务，懒加载视频列表（避免OOM）
   - 提交到任务引擎执行

3. **任务执行流程**
   - 分页加载视频元信息
   - 调用Alioth下载视频
   - 调用Mizar提取关键帧
   - AI推理：人脸识别和相似度计算
   - 保存匹配结果
   - 实时上报进度到云端

4. **用户查看结果**
   - 从ClickHouse查询结果（海量数据）
   - 生成临时签名URL（S3对象存储）
   - 返回结果列表

### 流程3：月底自动结算

```
定时任务 → 统计设备使用 → 计算费用 → 生成账单 → 发送通知 → 欠费处理
```

**为什么需要结算系统？**
- SaaS商业模式，需要按使用量计费
- 自动化流程，减少人工干预
- 欠费预警和自动停用，保护收益

---

## 五、关键优化点介绍

### 优化1：任务创建性能（我负责）

**问题**：创建任务时一次性加载所有视频元信息，内存瞬间增长2GB

**解决方案**：懒加载 + 分页 + LRU缓存
```
创建任务时只保存参数 → 执行时分页加载 → 缓存热数据
```

**效果**：
- 内存：2GB → 50MB（降低96%）
- 创建时间：10s → 500ms（提升20倍）
- GC频率：降低80%

### 优化2：IoT RPC超时（我负责）

**问题**：运维通过IoT创建任务，同步处理耗时10秒，ThingsBoard超时率30%

**解决方案**：RPC函数注册机制 + 异步处理
```
快速响应（100ms）→ 异步执行任务 → 通知结果
```

**效果**：
- 响应时间：10s → 100ms（提升100倍）
- 超时率：30% → 0.5%
- 成功率：99.5%+

### 优化3：视频下载内存泄漏（我参与）

**问题**：并发50路时内存8GB，频繁OOM重启

**解决方案**：
1. 限制gRPC缓冲区（MaxRecvMsgSize=10MB）
2. 对象池复用buffer（sync.Pool）
3. 用ISAPI替代CGO（避免海康SDK泄漏）
4. Context控制生命周期（防止goroutine泄漏）
5. 优先级队列（6级优先级调度）

**效果**：
- 内存：8GB → 2GB（降低75%）
- 并发：30 → 100+（提升3倍）
- 稳定性：30天+无重启

### 优化4：视频处理稳定性（我参与）

**问题**：异常视频导致处理服务崩溃，成功率只有90%

**解决方案**：
1. RAII管理FFmpeg资源（自动释放）
2. 完善错误处理和frame验证
3. 全I帧视频特殊处理
4. 线程安全缓存（shared_mutex）
5. PTS重排序（处理乱序帧）

**效果**：
- 截图成功率：90% → 99.5%+
- 零崩溃
- 处理速度提升20%

---

## 六、多租户架构设计

### 为什么需要多租户？

- **商业模式**：SaaS服务，支持多个客户
- **成本优化**：共享基础设施，降低成本
- **管理效率**：统一管理，集中运维

### 数据隔离策略（三层隔离）

**1. 数据库层**
- 所有表添加tenantId字段
- 复合索引：(tenantId, xxx)
- Row Level Security (RLS)

**2. 应用层**
- 中间件自动注入tenantId过滤条件
- Kong网关校验租户ID，防止跨租户访问

**3. 缓存层**
- Redis Key前缀隔离：`tenant:{tenantId}:{key}`
- 缓存失效时通过Redis Pub/Sub广播

### 租户配置隔离

每个租户可以独立配置：
- S3存储配置（对象存储路径）
- Kafka配置（消息队列Topic）
- 功能开关（启用/禁用某些功能）
- 计费规则（设备单价、免费额度）

---

## 七、分布式事务管理

### 租户创建的分布式事务

**为什么需要分布式事务？**

租户创建涉及多个系统：
1. PostgreSQL - 创建区域和租户记录
2. Keycloak - 创建管理员账号
3. ThingsBoard - 创建Customer
4. 聚类引擎 - 创建特征库

任何一步失败都要完整回滚，避免"半成品"租户。

**解决方案**：事务编排 + 补偿机制

```
1. 开启数据库事务
2. 执行各个步骤（有些可回滚，有些不可回滚）
3. 如果全部成功，提交事务
4. 如果任何一步失败，回滚事务 + 执行补偿操作
```

**技术亮点**：
- 数据库事务保证PostgreSQL的一致性
- 补偿机制清理外部资源
- 详细的错误日志便于排查
- 幂等性设计支持重试

---

## 八、ThingsBoard IoT平台集成

### 为什么选择ThingsBoard？

- **设备管理**：统一管理成百上千的边缘设备
- **双向通信**：云端可以远程控制边缘设备
- **属性同步**：配置变更实时下发
- **状态监控**：设备在线状态、健康度监控
- **MQTT协议**：适合物联网场景，低带宽、高可靠

### 集成的核心功能

**1. 设备认证**
- 使用设备Token认证
- 获取JWT AccessToken和RefreshToken
- Token自动刷新（提前10分钟）

**2. RPC远程调用**
- 云端下发任务创建、取消、系统重启等命令
- 边缘端快速响应，异步执行
- 通过属性上报执行结果

**3. 属性同步**
- 共享属性：云端下发配置
- 设备属性：边缘端上报状态
- 启动时拉取共享属性，确保配置一致

**4. 故障处理**
- Token过期自动刷新
- 连接断开自动重连
- 离线消息队列（网络恢复后自动同步）

---

## 九、面试中的常见开场问题

### Q1: 能简单介绍一下你的项目吗？

**标准答案**（参考上面的"项目开场白"）

### Q2: 为什么采用云边协同架构？

**答**：
- 边缘端处理视频，保护隐私，降低带宽
- 云端汇聚数据，进行大数据分析和统一管理
- 通过IoT平台实现云边通信

### Q3: 你在项目中主要负责什么？

**答**：
- Star的租户管理系统：多租户SaaS架构、数据隔离、结算系统
- Dipper的核心服务Merak：任务调度、IoT集成、性能优化
- 性能优化：任务创建、IoT RPC、视频下载、视频处理

### Q4: 项目的规模有多大？

**答**：
- 代码量：约20万行（Go + TypeScript + C++）
- 团队：10人左右
- 部署：500+租户，200+边缘设备，10,000+物联网设备
- 数据：日处理1000万+条抓拍记录

### Q5: 你遇到过最大的挑战是什么？

**答**：
- 分布式事务管理（租户创建涉及多个系统）
- IoT平台集成（Token管理、RPC超时）
- 性能优化（内存泄漏、并发问题）
- 多租户数据隔离和安全

---

## 十、面试中的展开话术

### 如果面试官问"架构设计"

"我们采用微服务架构，主要考虑以下几点：

1. **职责清晰**：每个服务专注一个领域
   - Merak：任务编排
   - Alioth：视频下载
   - Mizar：视频处理
   - Dubhe：系统管理

2. **独立扩展**：可以根据瓶颈独立扩展
   - 下载慢？扩展Alioth
   - 处理慢？扩展Mizar
   - 任务多？扩展Merak

3. **故障隔离**：一个服务故障不影响其他
   - 视频处理崩溃不影响任务调度
   - 下载超时不影响其他任务

4. **技术栈多样性**：选择最合适的技术
   - Go：高并发、快速开发
   - C++：视频处理性能
   - TypeScript：前端开发效率"

### 如果面试官问"技术难点"

"我遇到的主要难点有：

1. **分布式事务**（租户创建）
   - 跨多个系统，需要事务编排
   - 部分步骤无法回滚，需要补偿机制
   - 解决方案：try-catch + cleanup

2. **IoT平台集成**
   - Token管理和自动刷新
   - RPC调用超时
   - 属性同步一致性
   - 解决方案：提前刷新 + 异步处理 + 启动拉取

3. **性能优化**
   - 内存泄漏（goroutine、buffer、CGO）
   - 并发安全（map竞态）
   - 解决方案：pprof定位 + 对象池 + 同步原语

4. **多租户隔离**
   - 数据隔离（数据库、缓存、存储）
   - 性能隔离（大租户不影响小租户）
   - 安全隔离（防止跨租户访问）
   - 解决方案：三层隔离 + 网关校验"

### 如果面试官问"最自豪的优化"

"我最自豪的优化是IoT RPC异步化：

**问题**：任务创建耗时10秒，ThingsBoard RPC超时10秒，失败率30%

**原因**：同步处理，需要等待任务完全创建才能返回

**解决方案**：
1. 快速响应（100ms）：返回'已接受'
2. 异步执行：后台创建任务
3. 异步通知：通过属性上报结果

**效果**：
- 响应时间：10s → 100ms（提升100倍）
- 超时率：30% → 0.5%
- 代码可维护性显著提升

**关键代码**：
```go
func handleCreateTask(msg RpcMessage) {
  // 快速响应
  quickResp := buildAcceptedResponse(msg.RequestId)
  
  // 异步处理
  go func() {
    task := createTask()
    notifySuccess(task)
  }()
  
  return quickResp
}
```

这个优化不仅解决了超时问题，还改进了代码架构，使得RPC处理更加灵活。"

---

## 十一、准备的数据和指标

### 性能指标

| 指标 | 优化前 | 优化后 | 提升 |
|------|-------|-------|------|
| 任务创建时间 | 10s | 500ms | 20倍 |
| IoT RPC响应 | 10s | 100ms | 100倍 |
| 下载内存占用 | 8GB | 2GB | 75%↓ |
| 下载并发数 | 30 | 100+ | 3倍+ |
| 视频处理成功率 | 90% | 99.5%+ | 10%↑ |
| 系统MTBF | 7天 | 30天+ | 4倍+ |

### 业务指标

| 指标 | 数值 |
|------|------|
| 支持租户数 | 500+ |
| 管理设备数 | 10,000+ |
| 日处理数据 | 1000万+条 |
| 部署边缘设备 | 200+ |
| 并发视频流 | 100+ |
| 系统可用性 | 99.9% |

### 代码质量

| 指标 | 数值 |
|------|------|
| 代码覆盖率 | 70%+ |
| 代码行数 | 20万+ |
| 团队规模 | 10人 |
| 修复并发问题 | 50+ |

