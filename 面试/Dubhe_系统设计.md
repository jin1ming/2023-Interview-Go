# Dubhe (天枢) - 边缘端核心系统设计

## 1. 系统定位
**Dubhe (天枢)** 是运行在边缘计算节点上的**智能网关 (Edge Agent)**，它是连接云端平台与边缘设备的"脐带"。
其核心职责不仅是设备管理，更是边缘侧的**配置中心**、**服务总线**和**运维通道**。

---

## 2. 核心架构模式：推拉结合 (Pull-Push Hybrid)

针对边缘网络环境不稳定（弱网、断网）的特点，Dubhe 采用了**推拉结合**的通信模式，这是一种在分布式系统中平衡"一致性"与"实时性"的经典设计。

### 2.1 启动/重连阶段：Pull (拉模式)
- **场景**：设备刚启动，或网络断开后重连。
- **机制**：
  1. 设备订阅 `AttributeReloadResponse` Topic。
  2. 主动向云端发送 `Reload` 指令。
  3. 云端下发**全量**配置快照。
- **设计目的**：解决**最终一致性**问题。防止设备在离线期间错过了云端的某些配置修改，上线后主动同步最新状态。

### 2.2 运行阶段：Push (推模式)
- **场景**：设备在线运行中。
- **机制**：
  1. 建立 MQTT 长连接，订阅属性变更 Topic。
  2. 云端配置一旦修改，**毫秒级**推送到边缘。
  3. 结合**观察者模式**，Dubhe 收到变更后触发回调函数（如更新 License、修改网络）。
- **设计目的**：解决**强实时性**问题。满足 IoT 场景下对即时控制的需求，同时相比 HTTP 轮询大幅节省流量。

---

## 3. 关键功能模块

### 3.1 边缘配置中心 (Edge Config Center)
Dubhe 将 IoT 属性同步机制抽象为一套配置管理系统：
- **设备级配置**：支持"千人千面"，每台设备可拥有独立的配置（如不同的 AI 阈值、不同的 License）。
- **热更新 (Hot Reload)**：配置变更无需重启服务，通过 `Watcher` 机制实时生效。
- **闭环反馈 (ACK)**：配置下发执行后，Dubhe 会主动反向推送执行结果（成功/失败），解决了传统配置中心"只管发不管成"的盲区。

### 3.2 边缘服务总线 (Edge Service Bus)
Dubhe 充当了边缘侧的 **Sidecar / 网关** 角色，简化了其他微服务的开发：
- **架构**：Dubhe 启动本地 GRPC Server (`127.0.0.1:1236`)。
- **流程**：边缘侧的其他微服务（如 AI 任务调度 Merak、视频处理 Mizar）无需单独维护 MQTT 连接，而是通过调用 Dubhe 的 GRPC 接口与云端通信。
- **收益**：降低了系统耦合度，统一了出口流量管理。

### 3.3 特权运维通道 (Remote Ops)
为了在不依赖 VPN 的情况下实现对内网设备的远程运维，Dubhe 设计了特权执行机制：
- **远程 Shell**：利用 `nsenter` 工具突破容器隔离，支持云端下发 Shell 命令直接在**宿主机 (Host OS)** 上执行。
- **内网穿透**：支持动态开启端口转发 (Port Forwarding)，运维人员可通过云端直接访问边缘局域网内的 SSH 或 Web 服务。

---

## 4. 数据流向图

```mermaid
graph TD
    Cloud[云端 IoT 平台] <-->|MQTT 长连接| Dubhe[Dubhe Agent]
    
    subgraph 边缘计算节点 (Edge Node)
        Dubhe -- 1. 心跳/遥测/ACK --> Cloud
        Cloud -- 2. RPC指令/配置推送 --> Dubhe
        
        Dubhe -- GRPC (Localhost) --> Merak[任务调度服务]
        Dubhe -- GRPC (Localhost) --> Mizar[视频分析服务]
        Dubhe -- HTTP --> License[鉴权服务]
        Dubhe -- nsenter --> HostOS[宿主机内核]
    end
```

## 5. 面试技术亮点总结

1.  **架构模式创新**：
    将 IoT 协议（MQTT）封装为**配置中心**和**服务总线**，在边缘侧实现了微服务架构的落地。

2.  **解决"弱网"挑战**：
    通过**推拉结合**模式，既保证了离线重连后的数据一致性，又保证了在线时的控制实时性。

3.  **解决"运维"挑战**：
    创新性地使用**特权容器 (Privileged Container)** + **nsenter** 技术，在容器化部署环境下实现了对宿主机的底层管控能力。

4.  **解决"闭环"挑战**：
    实现了配置下发的**全链路闭环**（下发->生效->ACK），让运维人员对边缘状态了如指掌。
