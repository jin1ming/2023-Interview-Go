# 抖音/短视频系统设计

## 一、核心功能

| 功能 | 说明 |
|------|------|
| 视频上传 | 上传、转码、存储 |
| 视频播放 | CDN 分发、自适应码率 |
| 推荐 Feed | 个性化推荐（核心） |
| 互动 | 点赞、评论、分享、关注 |
| 直播 | 实时推拉流 |

---

## 二、整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端 App                            │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                         CDN                                  │
│                   视频分发、边缘缓存                           │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                      API Gateway                             │
└─────────────────────────────┬───────────────────────────────┘
                              │
    ┌─────────────────────────┼─────────────────────────────┐
    │              │              │              │           │
┌───▼───┐    ┌────▼────┐   ┌─────▼─────┐  ┌─────▼─────┐ ┌───▼───┐
│ 上传   │    │  推荐    │   │   互动    │  │   用户    │ │ 搜索  │
│ 服务   │    │  服务    │   │   服务    │  │   服务    │ │ 服务  │
└───┬───┘    └────┬────┘   └─────┬─────┘  └─────┬─────┘ └───┬───┘
    │             │              │              │           │
┌───▼─────────────▼──────────────▼──────────────▼───────────▼───┐
│                        基础设施                                │
│   MySQL | Redis | Kafka | ES | 对象存储 | 推荐引擎              │
└───────────────────────────────────────────────────────────────┘
```

---

## 三、视频上传与处理

### 上传流程

```
1. 客户端请求上传凭证
2. 客户端直传 OSS（分片上传）
3. OSS 回调通知服务端
4. 触发转码任务（异步）
5. 转码完成，视频可播放
```

```go
// 1. 获取上传凭证
func GetUploadToken(userID int64) (*UploadCredential, error) {
    videoID := snowflake.NextID()
    
    // 生成 OSS 直传凭证
    credential := oss.GeneratePostPolicy(
        bucket:     "video-raw",
        key:        fmt.Sprintf("%d/%d.mp4", userID, videoID),
        expiration: time.Now().Add(1 * time.Hour),
        callback:   "https://api.xxx.com/video/upload/callback",
    )
    
    return &UploadCredential{
        VideoID:    videoID,
        UploadURL:  credential.URL,
        Policy:     credential.Policy,
        Signature:  credential.Signature,
    }, nil
}

// 2. 上传完成回调
func UploadCallback(videoID int64, ossKey string) error {
    // 创建视频记录
    video := &Video{
        ID:        videoID,
        RawURL:    ossKey,
        Status:    "processing",
        CreatedAt: time.Now(),
    }
    db.Create(video)
    
    // 发送转码任务
    kafka.Send("video-transcode", &TranscodeTask{
        VideoID: videoID,
        RawURL:  ossKey,
    })
    
    return nil
}
```

### 视频转码

```go
// 转码消费者
func ConsumeTranscode(task *TranscodeTask) {
    // 1. 下载原视频
    rawVideo := oss.Download(task.RawURL)
    
    // 2. 多码率转码
    outputs := []TranscodeOutput{
        {Resolution: "1080p", Bitrate: "4000k"},
        {Resolution: "720p", Bitrate: "2000k"},
        {Resolution: "480p", Bitrate: "1000k"},
        {Resolution: "360p", Bitrate: "500k"},
    }
    
    for _, output := range outputs {
        // FFmpeg 转码
        transcoded := ffmpeg.Transcode(rawVideo, output)
        
        // 上传到 CDN 源站
        url := oss.Upload("video-cdn", transcoded)
        
        // 记录转码结果
        db.Create(&VideoVariant{
            VideoID:    task.VideoID,
            Resolution: output.Resolution,
            URL:        url,
        })
    }
    
    // 3. 生成封面
    cover := ffmpeg.ExtractFrame(rawVideo, 0)
    coverURL := oss.Upload("covers", cover)
    
    // 4. 更新视频状态
    db.Model(&Video{}).Where("id = ?", task.VideoID).Updates(map[string]interface{}{
        "status":    "ready",
        "cover_url": coverURL,
    })
}
```

---

## 四、视频播放与 CDN

### 自适应码率（HLS/DASH）

```
客户端根据网络状况自动切换清晰度：
  WiFi → 1080p
  4G   → 720p
  弱网 → 360p
```

### CDN 架构

```
用户请求 → 边缘节点（就近）→ 区域节点 → 源站（OSS）

缓存策略：
  - 热门视频：边缘节点缓存
  - 冷门视频：回源拉取
```

### 预加载优化

```go
// 客户端预加载下一个视频
func Preload(videoIDs []int64) {
    for i, id := range videoIDs {
        if i >= 3 {
            break  // 只预加载前3个
        }
        // 预加载前几秒
        prefetchURL := getVideoURL(id) + "?range=0-500000"
        http.Get(prefetchURL)
    }
}
```

---

## 五、推荐系统（核心）

### 推荐流程

```
1. 召回：从海量视频中初筛候选集（万级）
2. 粗排：简单模型快速排序（千级）
3. 精排：复杂模型精细排序（百级）
4. 重排：多样性、去重、业务规则
5. 返回：Top N 视频
```

### 召回策略

| 召回源 | 说明 |
|--------|------|
| 协同过滤 | 相似用户喜欢的视频 |
| 内容召回 | 相似标签/分类的视频 |
| 热门召回 | 近期热门视频 |
| 关注召回 | 关注作者的新视频 |
| 地域召回 | 同城/附近的视频 |

```go
func Recall(userID int64) []int64 {
    var candidates []int64
    
    // 1. 协同过滤召回
    cfVideos := recallByCF(userID, 1000)
    candidates = append(candidates, cfVideos...)
    
    // 2. 内容召回（基于用户兴趣标签）
    tags := getUserInterestTags(userID)
    contentVideos := recallByTags(tags, 1000)
    candidates = append(candidates, contentVideos...)
    
    // 3. 热门召回
    hotVideos := recallByHot(500)
    candidates = append(candidates, hotVideos...)
    
    // 4. 关注作者召回
    followVideos := recallByFollowing(userID, 500)
    candidates = append(candidates, followVideos...)
    
    // 去重
    return unique(candidates)
}
```

### 排序模型

```python
# 特征
features = {
    # 用户特征
    "user_id": user_id,
    "user_age": age,
    "user_gender": gender,
    "user_interest_tags": tags,
    
    # 视频特征
    "video_id": video_id,
    "video_duration": duration,
    "video_tags": tags,
    "author_id": author_id,
    
    # 交叉特征
    "user_author_follow": is_following,
    "user_tag_match": tag_similarity,
    
    # 统计特征
    "video_ctr": click_rate,
    "video_like_rate": like_rate,
    "video_finish_rate": finish_rate,
}

# 预测：用户对视频的兴趣分数
score = model.predict(features)
```

### 实时特征

```go
// 用户实时行为（Flink 实时计算）
type UserRealtimeFeature struct {
    UserID           int64
    RecentLikeTags   []string  // 最近点赞的标签
    RecentWatchTags  []string  // 最近观看的标签
    SessionDuration  int64     // 本次会话时长
    LastInteraction  time.Time // 最后互动时间
}

// 存储在 Redis，推荐时实时获取
redis.HSet("user:realtime:"+userID, feature)
```

---

## 六、互动系统

### 点赞

```go
func Like(userID, videoID int64) error {
    // 1. 写入点赞记录
    db.Create(&Like{UserID: userID, VideoID: videoID})
    
    // 2. 更新计数（Redis）
    redis.Incr("video:likes:" + videoID)
    
    // 3. 记录用户行为（用于推荐）
    kafka.Send("user-behavior", &Behavior{
        UserID:  userID,
        VideoID: videoID,
        Action:  "like",
    })
    
    return nil
}
```

### 评论

```go
func Comment(userID, videoID int64, content string) error {
    comment := &Comment{
        ID:        snowflake.NextID(),
        UserID:    userID,
        VideoID:   videoID,
        Content:   content,
        CreatedAt: time.Now(),
    }
    
    // 1. 写入评论
    db.Create(comment)
    
    // 2. 更新计数
    redis.Incr("video:comments:" + videoID)
    
    // 3. 通知作者
    kafka.Send("notification", &Notification{
        ToUser:  getVideoAuthor(videoID),
        Type:    "comment",
        Content: content,
    })
    
    return nil
}
```

---

## 七、数据模型

```sql
-- 视频表
CREATE TABLE videos (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    title VARCHAR(200),
    description TEXT,
    cover_url VARCHAR(500),
    duration INT,
    status VARCHAR(20),
    created_at TIMESTAMP,
    INDEX idx_user (user_id),
    INDEX idx_created (created_at)
);

-- 视频变体（多码率）
CREATE TABLE video_variants (
    video_id BIGINT,
    resolution VARCHAR(10),
    url VARCHAR(500),
    PRIMARY KEY (video_id, resolution)
);

-- 用户行为表（用于推荐）
CREATE TABLE user_behaviors (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    video_id BIGINT,
    action VARCHAR(20),  -- view/like/comment/share
    watch_duration INT,
    created_at TIMESTAMP,
    INDEX idx_user_time (user_id, created_at)
);
```

---

## 八、面试追问

| 问题 | 回答 |
|------|------|
| 视频如何秒开？ | 预加载 + CDN 边缘缓存 + 首帧优化 |
| 推荐如何冷启动？ | 热门兜底 + 用户属性 + 探索流量 |
| 如何避免信息茧房？ | 多样性重排 + 随机探索 + 兴趣扩展 |
| 大视频如何上传？ | 分片上传 + 断点续传 |
| 如何处理违规内容？ | 机器审核 + 人工复审 + 举报机制 |
| 直播如何实现？ | RTMP 推流 + HLS/FLV 拉流 + CDN 分发 |
